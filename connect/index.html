<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentification (Lien App Web Script)</title>
  <!-- Tailwind CSS pour le style -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Authentification SHA-256</h1>
    

    <!-- Indicateur de statut/message -->
    <div id="status-message" class="mb-4 p-3 rounded-lg text-center font-medium transition-all duration-300 hidden"></div>

    <!-- Sélecteur d'onglets (Login / Signup) -->
    <div class="flex mb-6 border-b border-gray-200">
      <button id="tab-login" onclick="showForm('login')"
              class="flex-1 py-3 text-lg font-semibold border-b-2 transition duration-200 focus:outline-none text-blue-600 border-blue-600">
        Se connecter
      </button>
      <button id="tab-signup" onclick="showForm('signup')"
              class="flex-1 py-3 text-lg font-semibold border-b-2 transition duration-200 focus:outline-none text-gray-500 border-transparent">
        Créer un compte
      </button>
    </div>

    <!-- FORMULAIRE PRINCIPAL -->
    <form id="auth-form" onsubmit="handleFormSubmit(event)" class="space-y-4">

      <!-- Champ Nom d'utilisateur -->
      <div>
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Nom d'utilisateur</label>
        <input type="text" id="username" name="username" required
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
      </div>

      <!-- Champ Mot de passe -->
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
        <input type="password" id="password" name="password" required
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
      </div>

      <!-- Sélecteur de Rôle (Visible SEULEMENT pour l'inscription) -->
      <div id="role-container" class="hidden">
        <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Rôle</label>
        <select id="role" name="role"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-white">
          <option value="employé">Employé</option>
          <option value="administrateur">Administrateur</option>
        </select>
      </div>

      <!-- Bouton Soumettre -->
      <button type="submit" id="submit-button"
              class="w-full py-3 mt-6 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition duration-200 disabled:opacity-50">
        Se connecter
      </button>

    </form>
  </div>

<script>
  let currentMode = 'login';
  const statusMessage = document.getElementById('status-message');
  const roleContainer = document.getElementById('role-container');
  const submitButton = document.getElementById('submit-button');
  const form = document.getElementById('auth-form');

  // ⚠️ MODIFIER CECI : Collez l'URL de votre App Web Script ici (Ex: https://script.google.com/macros/s/AKfyc...)
  const API_URL = 'https://script.google.com/macros/s/AKfycbxAkn0XbkdjuuMkDjJ5CMJU__mw36EyUaAphEoXpvt5O4fpDpKUpcHT3yr4TYcbB0MnAw/exec'; 

  /**
   * Affiche un message de statut.
   */
  function displayMessage(message, isSuccess) {
    statusMessage.textContent = message;
    statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
    statusMessage.classList.add(isSuccess ? 'bg-green-100' : 'bg-red-100', isSuccess ? 'text-green-800' : 'text-red-800');
  }

  /**
   * Bascule entre les formulaires de connexion et d'inscription.
   */
  function showForm(mode) {
    currentMode = mode;
    statusMessage.classList.add('hidden');

    const tabLogin = document.getElementById('tab-login');
    const tabSignup = document.getElementById('tab-signup');
    
    // Mise à jour des classes pour les onglets
    const updateTab = (tab, isActive) => {
        tab.classList.toggle('border-blue-600', isActive);
        tab.classList.toggle('text-blue-600', isActive);
        tab.classList.toggle('border-transparent', !isActive);
        tab.classList.toggle('text-gray-500', !isActive);
    };

    updateTab(tabLogin, mode === 'login');
    updateTab(tabSignup, mode === 'signup');

    // Afficher/Masquer le champ Rôle
    roleContainer.classList.toggle('hidden', mode === 'login');
    if (mode === 'signup') {
      document.getElementById('role').setAttribute('required', 'required');
      submitButton.textContent = "S'inscrire";
    } else {
      document.getElementById('role').removeAttribute('required');
      submitButton.textContent = "Se connecter";
    }
  }

  /**
   * Gère la soumission du formulaire et appelle l'API App Script via fetch.
   */
  async function handleFormSubmit(e) {
    e.preventDefault();

    if (API_URL === 'VOTRE_URL_DE_DÉPLOIEMENT_ICI') {
        displayMessage("Erreur: Veuillez mettre à jour l'API_URL dans le code.", false);
        return;
    }

    submitButton.disabled = true;
    submitButton.textContent = "Traitement...";
    statusMessage.classList.add('hidden');

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Création du payload pour le doPost du Script
    const apiPayload = {
        action: currentMode, // 'login' ou 'signup'
        username: data.username,
        password: data.password,
        role: data.role // N'est utilisé que pour l'inscription
    };

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            mode: 'cors', 
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(apiPayload)
        });

        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            let successMsg = result.message;
            if (result.role) {
                successMsg += ` (Rôle: ${result.role})`;
            }
            displayMessage(successMsg, true);
            if (currentMode === 'signup') form.reset();
        } else {
            displayMessage(result.message, false);
        }

    } catch (error) {
        console.error('Erreur API:', error);
        displayMessage(`Erreur de communication avec le backend : ${error.message}`, false);
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = currentMode === 'login' ? "Se connecter" : "S'inscrire";
    }
  }

  window.onload = function() {
    showForm('login');
  };

</script>
</body>
</html>
